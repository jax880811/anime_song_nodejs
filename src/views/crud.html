
<!DOCTYPE html>
<html>
<head>
    <title>CRUD Operations</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .form-container {
            margin-bottom: 20px;
        }
        .form-container input {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div style="text-align: right; padding: 10px;">
        <a href="/logout">ç™»å‡º</a>
        
        <a href="/login">ç™»å…¥</a> | <a href="/register">è¨»å†Š</a>
        
      </div>
      <div id="nowPlaying">
        <h3>ğŸ§ Now Playing: <span id="playingTitle">è¼‰å…¥ä¸­...</span></h3>
        <iframe id="songPlayer" width="560" height="315" frameborder="0" allow="autoplay" allowfullscreen></iframe>
        <div style="margin-top: 10px;">
          <button onclick="prevSong()">â®ï¸ ä¸Šä¸€é¦–</button>
          <button onclick="nextSong()">â­ï¸ ä¸‹ä¸€é¦–</button>
        </div>
      </div>
<h1>CRUD Operations</h1>


<!-- æ·»åŠ æ–°æ­Œæ›²çš„è¡¨å–® -->
<div class="form-container">
    <h2>Add New Song</h2>
    <form id="createForm">
        <input type="text" name="song_name" placeholder="Song Name" required>
        <input type="text" name="work_name" placeholder="Work Name">
        <input type="text" name="season_or_other" placeholder="Season or Other">
        <input type="number" name="broadcast_year" placeholder="Broadcast Year">
        <input type="number" name="broadcast_month" placeholder="Broadcast Month">
        <input type="text" name="singer_or_group" placeholder="Singer or Group">
        <input type="text" name="song_url" placeholder="Song URL">
        <button type="submit">Add Song</button>
    </form>
</div>

<!-- é¡¯ç¤ºæ‰€æœ‰æ­Œæ›² -->
<h2>All Songs</h2>
<table>
    <thead>
        <tr>
            <th>æ­Œæ›²åç¨±</th>
            <th>ä½œå“åç¨±</th>
            <th>å­£åº¦æˆ–å…¶ä»–</th>
            <th>æ’­å‡ºå¹´ä»½</th>
            <th>æ’­å‡ºæœˆä»½</th>
            <th>æ­Œæ‰‹æˆ–è€…è¡¨æ¼”åœ˜é«”</th>
            <th>éŸ³æ¨‚ç¶²å€</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="songList">
        <!-- æ­Œæ›²æ•¸æ“šå°‡é€šé JavaScript å‹•æ…‹å¡«å…… -->
    </tbody>
</table>

<!-- ç·¨è¼¯è¡¨å–®ï¼ˆéš±è—ï¼‰ -->
<div id="editFormContainer" style="display: none;">
    <h2>Edit Song</h2>
    <form id="editForm">
        <input type="text" name="song_name" placeholder="Song Name" required>
        <input type="text" name="work_name" placeholder="Work Name">
        <input type="text" name="season_or_other" placeholder="Season or Other">
        <input type="number" name="broadcast_year" placeholder="Broadcast Year">
        <input type="number" name="broadcast_month" placeholder="Broadcast Month">
        <input type="text" name="singer_or_group" placeholder="Singer or Group">
        <input type="text" name="song_url" placeholder="Song URL">
        <button type="submit">Save Changes</button>
        <button type="button" onclick="closeEditForm()">Cancel</button>
    </form>
</div>



<script>
/*
    let cursorMap = { 1: null }; // ç¬¬ 1 é  cursor ç‚º null
let currentPage = 1;
let totalPages = 1;

async function fetchSongsByPage(page) {
  const cursor = cursorMap[page] || null;
  const url = cursor ? `/api/music?lastSongName=${encodeURIComponent(cursor)}` : '/api/music';

  const response = await fetch(url);
  const data = await response.json();
  const songs = data.songs;

  currentPage = page;
  totalPages = Math.ceil(data.totalItems / 10);

  if (songs.length > 0 && !cursorMap[page + 1]) {
    cursorMap[page + 1] = data.lastSongName;
  }

  const songList = document.getElementById('songList');
  songList.innerHTML = songs.map(song => `
    <tr>
      <td>${song.song_name}</td>
      <td>${song.work_name}</td>
      <td>${song.season_or_other}</td>
      <td>${song.broadcast_year}</td>
      <td>${song.broadcast_month}</td>
      <td>${song.singer_or_group}</td>
      <td><a href="${song.song_url}" target="_blank">Listen</a></td>
      <td>
        <button onclick="openEditForm('${song.song_name}')">Edit</button>
        <button onclick="deleteSong('${song.song_name}')">Delete</button>
      </td>
    </tr>
  `).join('');

  renderPaginationUI();
}

// å‹•æ…‹æ¸²æŸ“é ç¢¼æŒ‰éˆ•
function renderPaginationUI() {
  const container = document.getElementById('pagination');
  container.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.disabled = i === currentPage;
    btn.onclick = () => fetchSongsByPage(i);
    container.appendChild(btn);
  }
}

// åˆå§‹è¼‰å…¥
fetchSongsByPage(1);
*/

function renderPagination(totalPages, currentPage) {
  const paginationContainer = document.getElementById('pagination');
  if (!paginationContainer) return;

  paginationContainer.innerHTML = '';

  for (let i = 1; i <= totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.disabled = i === currentPage;
    btn.onclick = () => fetchSongs(i);
    paginationContainer.appendChild(btn);
  }
}


 let currentPage = 1;

async function fetchSongs(page = 1) {
  const response = await fetch(`/api/music?page=${page}`);
  const data = await response.json();
  const songs = data.songs;
  const songList = document.getElementById('songList');

  songList.innerHTML = songs.map(song => `
    <tr>
        <td>${song.song_name}</td>
        <td>${song.work_name}</td>
        <td>${song.season_or_other}</td>
        <td>${song.broadcast_year}</td>
        <td>${song.broadcast_month}</td>
        <td>${song.singer_or_group}</td>
        <td><a href="${song.song_url}" target="_blank">Listen</a></td>
        <td>
            <button onclick="openEditForm('${song.song_name}')">Edit</button>
            <button onclick="deleteSong('${song.song_name}')">Delete</button>
        </td>
    </tr>
  `).join('');

  renderPagination(data.totalPages, data.currentPage);
}
  
    // æ·»åŠ æ–°æ­Œæ›²
    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        await fetch('/api/music', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        fetchSongs(); // åˆ·æ–°æ­Œæ›²åˆ—è¡¨
        e.target.reset(); // æ¸…ç©ºè¡¨å–®
    });

    // åˆªé™¤æ­Œæ›²
    async function deleteSong(songName) {
        await fetch(`/api/music/${songName}`, { method: 'DELETE' });
        fetchSongs(); // åˆ·æ–°æ­Œæ›²åˆ—è¡¨
    }

    // æ‰“é–‹ç·¨è¼¯è¡¨å–®
    async function openEditForm(songName) {
        const response = await fetch(`/api/music/${songName}`);
        const song = await response.json();

        // å¡«å……ç·¨è¼¯è¡¨å–®
        const editForm = document.getElementById('editForm');
        editForm.song_name.value = song.song_name;
        editForm.work_name.value = song.work_name;
        editForm.season_or_other.value = song.season_or_other;
        editForm.broadcast_year.value = song.broadcast_year;
        editForm.broadcast_month.value = song.broadcast_month;
        editForm.singer_or_group.value = song.singer_or_group;
        editForm.song_url.value = song.song_url;

        // é¡¯ç¤ºç·¨è¼¯è¡¨å–®
        document.getElementById('editFormContainer').style.display = 'block';
    }

    // é—œé–‰ç·¨è¼¯è¡¨å–®
    function closeEditForm() {
        document.getElementById('editFormContainer').style.display = 'none';
    }

    // æäº¤ç·¨è¼¯è¡¨å–®
    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        await fetch(`/api/music/${data.song_name}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        fetchSongs(); // åˆ·æ–°æ­Œæ›²åˆ—è¡¨
        closeEditForm(); // é—œé–‰ç·¨è¼¯è¡¨å–®
    });

    // åˆå§‹åŠ è¼‰æ­Œæ›²åˆ—è¡¨
    fetchSongs();


    // æ’­æ”¾éš¨æ©Ÿæ­Œæ›²
async function playRandomSong() {
    const res = await fetch('/api/music/random');
    const song = await res.json();

    if (song && song.song_url) {
        // æ’­æ”¾å€æ›´æ–°
        document.getElementById('playingTitle').textContent = song.song_name;

        // è™•ç† YouTube é€£çµï¼ˆè½‰æˆåµŒå…¥æ ¼å¼ï¼‰
        let embedURL = song.song_url;
        if (embedURL.includes('youtube.com/watch?v=')) {
            const videoId = embedURL.split('v=')[1].split('&')[0];
            embedURL = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
        }

        document.getElementById('songPlayer').src = embedURL;
    }
}


let playlist = [];
let currentIndex = 0;

// è¼‰å…¥æ‰€æœ‰æ­Œæ›²ä¸¦åˆå§‹åŒ–æ’­æ”¾
async function initPlaylist() {
    const res = await fetch('/api/music'); // â† å›å‚³çš„æ˜¯ { songs: [...], ... }
    const data = await res.json(); // âœ… å…ˆè½‰æˆ JSON ç‰©ä»¶
    playlist = data.songs || [];  // âœ… æ­£ç¢ºå–å¾—æ­Œæ›²é™£åˆ—

    if (playlist.length > 0) {
        currentIndex = Math.floor(Math.random() * playlist.length); // éš¨æ©Ÿé¸é¦–æ­Œ
        playCurrentSong();
    }
}

// æ’­æ”¾ç•¶å‰æ­Œæ›²
function playCurrentSong() {
    if (!playlist || playlist.length === 0) {
        document.getElementById('playingTitle').textContent = 'No songs available.';
        document.getElementById('songPlayer').src = '';
        return;
    }

    const song = playlist[currentIndex];
    document.getElementById('playingTitle').textContent = song.song_name;

    let embedURL = song.song_url;

    if (embedURL.includes('youtube.com/watch?v=')) {
        const videoId = embedURL.split('v=')[1].split('&')[0];
        embedURL = `https://www.youtube.com/embed/${videoId}?autoplay=1&enablejsapi=1`;
    }

    const iframe = document.getElementById('songPlayer');
    iframe.src = embedURL;

    setTimeout(bindYouTubeEndEvent, 1000); // é˜²æ­¢é‚„æ²’è¼‰å…¥ API å°±ç¶å®šéŒ¯èª¤
}

// åˆ‡æ›ä¸‹ä¸€é¦–
function nextSong() {
    currentIndex = (currentIndex + 1) % playlist.length;
    playCurrentSong();
}

// åˆ‡æ›ä¸Šä¸€é¦–
function prevSong() {
    currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
    playCurrentSong();
}

// ç¶å®š YouTube æ’­æ”¾çµæŸäº‹ä»¶ï¼ˆéœ€ YouTube IFrame APIï¼‰
function bindYouTubeEndEvent() {
    if (!window.YT || !YT.Player) return;

    new YT.Player('songPlayer', {
        events: {
            'onStateChange': (event) => {
                if (event.data === YT.PlayerState.ENDED) {
                    nextSong(); // æ’­å®Œè‡ªå‹•åˆ‡ä¸‹ä¸€é¦–
                }
            }
        }
    });
}

// è¼‰å…¥ YouTube IFrame API
function loadYouTubeAPI() {
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
}
// åˆå§‹è¼‰å…¥æ’­æ”¾
playRandomSong();
// å•Ÿå‹•æ•´å€‹æ’­æ”¾ç³»çµ±
loadYouTubeAPI();
initPlaylist();

</script>

<!-- åˆ†é æŒ‰éˆ•å®¹å™¨ -->
<div id="pagination" style="margin-top: 20px; text-align: center;"></div>

</body>
</html>